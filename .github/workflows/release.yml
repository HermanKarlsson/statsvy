name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (SemVer, e.g. 1.1.0)"
        required: true
        type: string
      source_branch:
        description: "Branch containing release changes"
        required: true
        default: "develop"
        type: string
      target_branch:
        description: "Release branch"
        required: true
        default: "main"
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Manual Release
    runs-on: ubuntu-latest
    concurrency: release
    if: github.repository == 'HermanKarlsson/statsvy'
    env:
      RELEASE_VERSION: ${{ inputs.version }}
      SOURCE_BRANCH: ${{ inputs.source_branch }}
      TARGET_BRANCH: ${{ inputs.target_branch }}
      DISPATCH_REF: ${{ github.ref_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ env.TARGET_BRANCH }}

      - name: Validate inputs and repository state
        shell: bash
        run: |
          set -euo pipefail

          if ! [[ "$RELEASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: version must follow MAJOR.MINOR.PATCH, e.g. 1.1.0"
            exit 1
          fi

          if [ "$TARGET_BRANCH" != "main" ]; then
            echo "ERROR: target_branch must be main"
            exit 1
          fi

          if [ "$DISPATCH_REF" != "$TARGET_BRANCH" ]; then
            echo "ERROR: Run this workflow from the main branch in Actions"
            exit 1
          fi

          git fetch --prune --tags origin
          git fetch origin "$SOURCE_BRANCH":"$SOURCE_BRANCH"
          git fetch origin "$TARGET_BRANCH":"$TARGET_BRANCH"

          if git rev-parse -q --verify "refs/tags/v$RELEASE_VERSION" >/dev/null; then
            echo "ERROR: Tag v$RELEASE_VERSION already exists"
            exit 1
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Install git-cliff
        uses: taiki-e/install-action@git-cliff

      - name: Generate changelog from source branch
        shell: bash
        run: |
          set -euo pipefail
          git checkout "$SOURCE_BRANCH"
          git reset --hard "origin/$SOURCE_BRANCH"
          git-cliff --config cliff.toml --output /tmp/CHANGELOG.md

      - name: Create release commit on main
        shell: bash
        run: |
          set -euo pipefail

          git checkout "$TARGET_BRANCH"
          git reset --hard "origin/$TARGET_BRANCH"
          git merge --squash --no-commit "origin/$SOURCE_BRANCH"
          cp /tmp/CHANGELOG.md CHANGELOG.md

          python - <<'PY'
          from pathlib import Path
          import re

          version = "${{ env.RELEASE_VERSION }}"
          version_file = Path("src/statsvy/__init__.py")
          content = version_file.read_text(encoding="utf-8")
          updated = re.sub(
              r'__version__\s*=\s*"[0-9]+\.[0-9]+\.[0-9]+"',
              f'__version__ = "{version}"',
              content,
              count=1,
          )
          if updated == content:
              raise SystemExit("Could not update __version__ in src/statsvy/__init__.py")
          version_file.write_text(updated, encoding="utf-8")
          PY

          uv run ruff format --check .
          uv run ruff check .
          uv run ty check .
          uv run pytest -v --cov=statsvy --cov-report=term-missing --cov-fail-under=90

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md src/statsvy/__init__.py
          git commit -m "release: v$RELEASE_VERSION"
          git push origin "$TARGET_BRANCH"

      - name: Create and push release tag
        shell: bash
        run: |
          set -euo pipefail
          git tag "v$RELEASE_VERSION"
          git push origin "v$RELEASE_VERSION"

      - name: Build package artifacts
        run: uv run python -m build

      - name: Publish GitHub release and assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          target_commitish: ${{ env.TARGET_BRANCH }}
          body_path: CHANGELOG.md
          files: dist/*
